---
title: 'Documentation: Housing Affordability and School Quality by Occupation Tool'
author: "C. McClintock, for the Shift Research Lab"
date: "Summer 2018"
output: 
  html_document:
    toc: true
    toc_float: true
    toc_collapsed: true
    toc_depth: 5
    theme: lumen
runtime: shiny
---

```{r setup, include=FALSE, warning=FALSE, message=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r lib, echo=FALSE, warning=FALSE, message=FALSE, error=FALSE}
library(knitr)
library(tidyverse)
library(shiny)
library(plotly)
```

## About This Project
##### Housing Affordability and Access to Quality Education by Occupation
The aim of this project is to develop a tool where a user selects her occupation from a list, and is shown a graph of neighborhoods in the Denver metropolitan area by percent of houses in a given neighborhood that are afforable given the median occupational wages for a selected occupation, and reading and math proficiency and high school graduation rates for schools in that neighborhood. The points would then also be scaled by average commute time.

##### Why? 


## Data & Sources
* Median Occupational Wages *from the Bureau of Labor Statistics*
    + [2017 BLS Wage Data](https://www.bls.gov/oes/current/oes_nat.htm), data filtered to "Denver-Aurora-Lakewood, CO" area. 
* School Quality *from the Colorado Department of Education*
    + [2017 CMAS English Language Arts and Math Proficiency](https://www.cde.state.co.us/assessment)
    + [2014-2017 High School Graduation Rates](https://www.cde.state.co.us/cdereval/gradratecurrent)
* Average Commute Time *from the American Community Survey*
    + [ACS 2016 (5-Year Estimates)](https://www.socialexplorer.com/tables/ACS2016_5yr/R11709778) from Social Explorer, for the seven county Denver metro area, with tracts matched to neighborhoods. 
* Housing Affordability Data *from each of the seven counties in the Denver area*
    + Adams County
    + Arapahoe County
    + Boulder County
    + Broomfield County
    + Denver County
    + Douglas County
    + Jefferson County

## Methodology

#### Occupational Wages

Occupational wage data comes from the Bureau of Labor Statistics, from the 2017 calendar year. The data was filtered to the "Denver-Aurora-Lakewood, CO" area. The tool will utilize the annual median wages data, and the user will be able to select first their industry, and then their occupation, based on BLS occupation and industry classifications.

Cleaning script can be found in `bls.clean.R`. 


#### School Quality

School quality is determined by CMAS proficiency in reading and math and high school graduation rates. Both data sets were retrieved from the Colorado Department of Education data portal. Schools were matched to neighborhoods by geographic location through a geospatial join in QGIS.  

CMAS data was aggregated by grade, then by subject area to create an average proficiency score for each school. School level data was then aggregated by neighborhood to create an average proficiency score for each neighborhood. 3 neighborhoods had high school graduation rates, but no CMAS scores, and 119 neighborhoods had CMAS scores but no high school graduation rates. The measures of central tendency and distributions for the CMAS data and the graduation rate date were different, so rather than take the average, the both data sets were given percentile scores and then an average was taken where both values existed which became the school quality measure. Where only one value existed, that become the school quality measure. 

This is thus a relative metric, with each neighborhoods schools given a score relative to all other neighborhoods in the Denver metro area. 

Qs: Should this be absolute? Is there a better way to combine the data? 

Cleaning script can be found in `ed.clean.R`. 

#### Average Commute Time

Average commute time is based on 5 year American Community Survey tract level data for average reported commute time. Tracts were then matched to neighborhoods with a matching table. Neighborhood averages were computed as the average of all matched tracts (the difference between average and median was frequently 0, always less than 2 minutes).

Cleaning script can be found in `acs.clean.R`. 

#### Housing Affordability

Parcel data was retrieved from the Adams, Arapahoe, Broomfield, Boulder, Denver, Douglas, and Jefferson County assessor's offices. 

Cleaning script can be found in `housing.clean.R`. 

## Scripts

* Cleaning
    + School Quality: `ed.clean.R`
    + Housing Affordability: `housing.clean.R`
    + Average Commute Time: `acs.clean.R`
    + Median Occupation Wages: `bls.clean.R`
    
* Shiny: in `app`
    + App Script: `app.R`


## To Do
*
    + decide on housing affordability metric (currently using 2.6 times annual income?)
    + get new school data from Nikki
    + explore Shiny and Tableau options
    + find a way to count T/F values faster
    + Extensively document code

## Sample Output 


``` {r app, echo=FALSE, warning=FALSE}

load("wages.Rdata")
load("ed.Rdata")
load("commute.Rdata")
load("adams.Rdata")

avgcommute <- select(avgcmt, name, avgcommute)
avgcommute <- rename(avgcommute, "nbhd"="name")
schools <- select(all, nbhd, schoolquality)
affordable <- aff
affordable <- rename(affordable, "nbhd"="nhname")

data <- left_join(schools, avgcommute, by="nbhd")
data <- left_join(data, affordable, by="nbhd")

ui <- shinyUI(fluidPage(
  titlePanel("Housing Affordability Tool"),
  
  sidebarPanel(
    htmlOutput("industry_selector"),
    htmlOutput("occupation_selector")
  ),
  mainPanel(plotlyOutput("plot"))
))

server <- shinyServer(function(input, output) {
  
  output$plot <- renderPlotly({
    plot_ly(data = subset(data, data$occupation==input$occupation), x = ~schoolquality, y = ~affordability, type = 'scatter', mode = 'markers',
            color = ~avgcommute, colors = 'Blues', marker = 
              list(size = ~avgcommute, opacity = 0.5), hoverinfo = 'text',
            text = ~paste('Neighborhood:', nbhd, '<br>Percent Affordable Housing', affordability,  '<br>School Quality (Percentile):', 
                          schoolquality)) %>%
      layout(title = 'Housing Affordability and School Quality by Occupation',
             xaxis = list(title = 'School Quality',
                          gridcolor = 'rgb(255, 255, 255)',
                          zerolinewidth = 1,
                          ticklen = 5,
                          gridwidth = 2),
             yaxis = list(title = 'Percent Affordable Housing',
                          gridcolor = 'rgb(255, 255, 255)',
                          zerolinewidth = 1,
                          ticklen = 5,
                          gridwidth = 2),
             paper_bgcolor = 'rgb(243, 243, 243)',
             plot_bgcolor = 'rgb(243, 243, 243)')
  })
  
  output$industry_selector <- renderUI({
    
    selectInput(
      inputId = "industry", 
      label = "Industry:",
      choices = as.character(unique(bls.spec$industry)),
      selected = "Management Occupations")
    
  })
  
  output$occupation_selector <- renderUI({
    
    available <- bls.spec[bls.spec$industry == input$industry, "occ_title"]
    
    selectInput(
      inputId = "occupation", 
      label = "Occupation:",
      choices = unique(available),
      selected = unique(available)[1])
    
  })
})
##
shinyApp(ui = ui, server = server)
```



